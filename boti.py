#!/usr/bin/env python3
# boti.py - ğŸ¤– ShytoshiBot Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©

import os
import json
import random
import subprocess
import requests
from datetime import datetime

# ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø³Ø© =====
BOT_NAME = "momo"
GITHUB_REPO = "https://github.com/public36/botio.git"
NETLIFY_BUILD_HOOK = "https://api.netlify.com/build_hooks/6887ae6d1960c1aff4e4d209"  # âœ… hook Ù…Ø­Ø¯Ø«
TELEGRAM_BOT_TOKEN = "7081826639:AAEGWibR9Qq-o3wKoWw4MZ5zMBGHUxuHISg"
TELEGRAM_CHAT_ID = "5326702321"
SSH_KEY_PATH = "/data/data/com.termux/files/home/.ssh/id_ed25519"
PROJECT_DIR = "/sdcard/zuku"
REPO_DIR = os.path.join(PROJECT_DIR, "botio")
LOG_FILE = os.path.join(REPO_DIR, "log.txt")

# ===== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def log(msg):
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    print(f"{BOT_NAME} | {msg}")
    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(f"{now} - {msg}\n")

def send_telegram(msg):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": msg}
        requests.post(url, json=payload)
    except Exception as e:
        log(f"âŒ Telegram error: {e}")

def generate_ssh_key():
    if os.path.exists(SSH_KEY_PATH):
        return
    log("ğŸ” ØªÙˆÙ„ÙŠØ¯ Ù…ÙØªØ§Ø­ SSH Ø¬Ø¯ÙŠØ¯ ...")
    os.system("bash ssh.sh")

def clone_repo():
    if not os.path.exists(PROJECT_DIR):
        os.makedirs(PROJECT_DIR)
    os.chdir(PROJECT_DIR)
    
    if not os.path.exists(os.path.join(REPO_DIR, ".git")):
        subprocess.run(["git", "clone", GITHUB_REPO])
        log("âœ… ØªÙ… Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.")
        send_telegram("ğŸ“¥ ØªÙ… Ø§Ø³ØªÙ†Ø³Ø§Ø® botio Ù…Ù† GitHub.")
    else:
        log("ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. ØªØ®Ø·ÙŠØª Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø®.")

def update_products():
    prod_path = os.path.join(REPO_DIR, "products.json")
    if not os.path.exists(prod_path):
        log("âŒ Ù…Ù„Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
        return "unknown-product"

    try:
        with open(prod_path, "r", encoding="utf-8") as f:
            products = json.load(f)
    except:
        products = []

    new_product = {
        "id": len(products) + 1,
        "name": f"AI Product {random.randint(1000, 9999)}",
        "price": f"{random.randint(10, 99)}â‚¬",
        "description": "Generated by ShytoshiBot.",
        "image": f"https://picsum.photos/300?random={random.randint(1,9999)}"
    }
    products.append(new_product)

    with open(prod_path, "w", encoding="utf-8") as f:
        json.dump(products, f, indent=2, ensure_ascii=False)

    log(f"ğŸ†• Product added: {new_product['name']}")
    return new_product['name']

def configure_git_safe_dir():
    subprocess.run(["git", "config", "--global", "--add", "safe.directory", REPO_DIR])

def push_to_github():
    if not os.path.exists(os.path.join(REPO_DIR, ".git")):
        log("âŒ Ù…Ø¬Ù„Ø¯ Git ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
        return

    os.chdir(REPO_DIR)
    os.environ["GIT_SSH_COMMAND"] = f"ssh -i {SSH_KEY_PATH}"
    configure_git_safe_dir()

    subprocess.run(["git", "config", "user.email", "mbomadian23@gmail.com"])
    subprocess.run(["git", "config", "user.name", BOT_NAME])

    # Ø³Ø­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† GitHub
    pull = subprocess.run(["git", "pull", "--rebase", "origin", "main"],
                          capture_output=True, text=True)
    log(f"[Git Pull] {pull.stdout.strip()}")

    subprocess.run(["git", "add", "."], check=True)

    commit = subprocess.run(["git", "commit", "-m", f"{BOT_NAME} update {datetime.now().isoformat()}"],
                            capture_output=True, text=True)

    if "nothing to commit" in commit.stdout.lower():
        log("ğŸ“­ Ù„Ø§ ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ù€ push.")
        return

    try:
        push = subprocess.run(["git", "push", "origin", "main"],
                              capture_output=True, text=True, check=True)
        log("âœ… Changes pushed to GitHub.")
        send_telegram("ğŸ“¤ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù†ÙØ´Ø±Øª Ø¥Ù„Ù‰ GitHub.")
    except subprocess.CalledProcessError as e:
        log(f"âŒ Push failed:\n{e.stderr}")
        send_telegram(f"âŒ ÙØ´Ù„ push Ø¥Ù„Ù‰ GitHub:\n{e.stderr}")

def trigger_netlify():
    try:
        log(f"ğŸŒ Triggering Netlify build: {NETLIFY_BUILD_HOOK}")
        res = requests.post(NETLIFY_BUILD_HOOK)
        if res.status_code == 200:
            log("âœ… Netlify build triggered.")
            send_telegram("ğŸš€ Build Ø¬Ø¯ÙŠØ¯ Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ Netlify.")
        else:
            log(f"âš ï¸ Netlify trigger failed: {res.status_code}")
            send_telegram(f"âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Netlify: {res.status_code}")
    except Exception as e:
        log(f"âŒ Netlify error: {str(e)}")
        send_telegram(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Netlify:\n{e}")

def main():
    log("\nğŸš€ Starting full update and deployment...\n")
    generate_ssh_key()
    clone_repo()
    product_name = update_products()
    push_to_github()
    trigger_netlify()
    send_telegram(f"âœ… All tasks completed.\nğŸ†• Product: {product_name}")
    log("âœ… All tasks completed.\n")

if __name__ == "__main__":
    main()
